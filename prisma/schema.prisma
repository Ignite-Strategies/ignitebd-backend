// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Owner {
  id          String   @id @default(cuid())
  firebaseId  String   @unique
  name        String
  email       String   @unique
  photoURL    String?  // Profile picture URL (from Firebase)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Company relationships only (basic personhood)
  // Owner sees everything scoped to companyId - all CRM data is company-scoped
  ownedCompanies Company[] @relation("OwnerOf")  // Companies this owner owns (super admin)
  managesCompanies Company[] @relation("ManagerOf")  // Companies this owner manages (delegated by owner)
  staffOf     Company[] @relation("StaffOf")       // Companies this owner is staff of (when invited)

  @@map("owners")
}

model Company {
  id          String   @id @default(cuid())
  companyName String
  companyAddress String?
  companyIndustry String?  // Self-reported industry
  companyAnnualRev Float? // Self-reported annual revenue (stored as number, can be converted from range)
  yearsInBusiness Int? // Self-reported years in business
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Ownership & Management
  ownerId     String   // Original creator/owner of the company (super admin)
  owner       Owner     @relation("OwnerOf", fields: [ownerId], references: [id])
  managerId   String?  // Manager assigned by owner - can manage CRM stack but not company settings
  manager     Owner?    @relation("ManagerOf", fields: [managerId], references: [id])
  staff       Owner[]   @relation("StaffOf")
  
  // CRM Data (all contacts, prospects, clients)
  prospects   Prospect[]
  clients     Client[]
  contacts    Contact[]  // Universal person container - includes prospects, clients, and other contacts
  pipelineEntries BDPipelineEntry[]
  // TODO: Commented out stacks - will be revenuegen or similar later
  // revenueStacks RevenueStack[]
  // humanCapitalStacks HumanCapitalStack[]
  // targetAcquisitionStacks TargetAcquisitionStack[]
  contactLists ContactList[]
  campaigns   Campaign[]
  templates   Template[]
  personas    Persona[]
  proposals   Proposal[]
  events      Event[]
  meetings    Meeting[]
  adCampaigns AdCampaign[]

  @@map("companies")
}

model Client {
  id          String   @id @default(cuid())
  name        String
  email       String?
  phone       String?
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  contactId   String?  // Optional reference to universal Contact record
  contact     Contact? @relation(fields: [contactId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  pipelineEntries BDPipelineEntry[] @relation("ClientPipelineEntries")        

  @@map("clients")
}

model Prospect {
  id          String   @id @default(cuid())
  name        String
  email       String?
  phone       String?
  companyId   String   // Ignite company that owns this prospect record (CRM owner)
  company     Company  @relation(fields: [companyId], references: [id])
  prospectCompanyId String?  // The prospect's company (e.g., "Acme Corp" - the company they work for)
  contactId   String?  // Optional reference to universal Contact record
  contact     Contact? @relation(fields: [contactId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  pipelineEntries BDPipelineEntry[] @relation("ProspectPipelineEntries")

  @@map("prospects")
}

model BDPipelineEntry {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  clientId    String?  // Optional - if they're already a client
  client      Client? @relation("ClientPipelineEntries", fields: [clientId], references: [id])
  prospectId  String?  // Optional - if they're still a prospect
  prospect    Prospect? @relation("ProspectPipelineEntries", fields: [prospectId], references: [id])
  stage       String   // Pipeline stage (e.g., "aware", "interested", "qualified", "proposal", "closed_won", "closed_lost")
  status      String   // Status within stage (e.g., "active", "paused", "completed")
  value       Float?   // Deal value
  probability Float?   // Probability of closing (0-100)
  notes       String?  // Additional notes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("bd_pipeline_entries")
}

model Assessment {
  id          String   @id @default(cuid())
  name        String
  company     String
  industry    String
  workTooMuch String   // Response to "Do you feel you work too much on tasks?"
  assignTasks String   // Response to "You adequately assign to others"
  wantMoreClients String // Response to "Do you want to bring on more clients?"
  revenueGrowthPercent Int? // Revenue growth percentage they want
  totalVolume Float?   // Total volume target
  bdSpend     Float?   // Current BD spend
  score       Int      // Calculated growth potential score
  insights    String?  // JSON string of insights
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("assessments")
}

model PlatformProspect {
  id          String   @id @default(cuid())
  name        String
  email       String
  company     String
  industry    String
  workTooMuch String   // Response to "Do you feel you work too much on tasks?"
  assignTasks String   // Response to "You adequately assign to others"
  wantMoreClients String // Response to "Do you want to bring on more clients?"
  revenueGrowthPercent Int? // Revenue growth percentage they want
  totalVolume Float?   // Total volume target
  bdSpend     Float?   // Current BD spend
  score       Int      // Calculated growth potential score
  insights    String?  // JSON string of insights
  leadStatus  String   @default("new") // new, contacted, qualified, converted
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("platform_prospects")
}

// TODO: Commented out stacks - will be revenuegen or similar later
// model RevenueStack {
//   id          String   @id @default(cuid())
//   companyId   String
//   company     Company  @relation(fields: [companyId], references: [id])
//   
//   // Product Definition
//   productName String
//   
//   // Unit Economics
//   avgGrossPerUnit Float
//   avgOrdersPerMonthPerCustomer Float
//   
//   // Volume Metrics
//   totalCustomers Int
//   
//   // Calculated Fields
//   totalUnitsPerMonth Float
//   monthlyRevenue Float
//   annualRevenue Float
//   
//   createdAt   DateTime @default(now())
//   updatedAt   DateTime @updatedAt
//
//   @@map("revenue_stacks")
// }

// model HumanCapitalStack {
//   id          String   @id @default(cuid())
//   companyId   String
//   company     Company  @relation(fields: [companyId], references: [id])
//   
//   // Team Structure
//   totalTeamMembers Int
//   avgHoursPerWeek Float
//   founderHoursPerWeek Float?
//   
//   // Production Metrics
//   hoursPerUnit Float
//   totalUnitsPerMonth Int
//   
//   // Optional Advanced
//   contractorHours Float?
//   
//   // Calculated Fields
//   totalNeededHours Float
//   teamCapacity Float
//   totalCapacity Float
//   utilization Float
//   
//   createdAt   DateTime @default(now())
//   updatedAt   DateTime @updatedAt
//
//   @@map("human_capital_stacks")
// }

// model TargetAcquisitionStack {
//   id          String   @id @default(cuid())
//   companyId   String
//   company     Company  @relation(fields: [companyId], references: [id])
//   
//   // Baseline Revenue
//   previousRevenue Float
//   currentMonthlyRevenue Float
//   
//   // Target Definition
//   targetRevenue Float
//   timeHorizon Int // months
//   
//   // Revenue Delta
//   increaseNeeded Float
//   growthPercent Float
//   
//   // Operational Targets (from Revenue Stack)
//   avgUnitValue Float
//   avgUnitsPerCustomer Float
//   
//   // Calculated Fields
//   newUnitsNeeded Float
//   newCustomersNeeded Float
//   
//   createdAt   DateTime @default(now())
//   updatedAt   DateTime @updatedAt
//
//   @@map("target_acquisition_stacks")
// }

// ============================================
// Contact Management Models
// ============================================

model ContactList {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  name        String
  description String?
  type        String?  // Campaign, Event, Organization, Custom
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  contacts    ContactListMember[]
  campaigns   Campaign[] @relation("ContactListCampaigns")

  @@map("contact_lists")
}

model Contact {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  firstName   String?
  lastName    String?
  email       String?
  phone       String?
  companyName String?
  title       String?
  notes       String?
  tags        String[] // Array of tags (e.g., ["prospect", "client", "vendor", "partner"])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  listMemberships ContactListMember[]
  campaignRecipients CampaignRecipient[]
  // Reverse relations - a Contact can be linked to a Prospect or Client
  prospects  Prospect[]
  clients    Client[]

  @@map("contacts")
}

model ContactListMember {
  id          String   @id @default(cuid())
  contactListId String
  contactList ContactList @relation(fields: [contactListId], references: [id], onDelete: Cascade)
  contactId   String
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([contactListId, contactId])
  @@map("contact_list_members")
}

// ============================================
// Outreach Models (Campaigns, Templates, Email)
// ============================================

model Campaign {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  contactListId String?
  contactList ContactList? @relation("ContactListCampaigns", fields: [contactListId], references: [id])
  name        String
  description String?
  subject     String
  message     String   // Email body with variable placeholders
  status      String   @default("draft") // draft, scheduled, sending, sent, paused
  sentAt      DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  recipients  CampaignRecipient[]
  attachments CampaignAttachment[]

  @@map("campaigns")
}

model CampaignRecipient {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contactId   String
  contact     Contact  @relation(fields: [contactId], references: [id])
  email       String   // Snapshot of email at send time
  status      String   @default("pending") // pending, sent, delivered, opened, clicked, replied, bounced
  openedAt    DateTime?
  clickedAt   DateTime?
  repliedAt   DateTime?
  sentAt      DateTime?
  createdAt   DateTime @default(now())

  @@map("campaign_recipients")
}

model CampaignAttachment {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  fileName    String
  fileUrl     String
  fileSize    Int?
  mimeType    String?
  createdAt   DateTime @default(now())

  @@map("campaign_attachments")
}

model Template {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  name        String
  subject     String
  body        String   // Email body template with variables
  category    String?  // Outreach, Follow-up, Introduction, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("templates")
}

// ============================================
// Persona Models
// ============================================

model Persona {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  name        String
  title       String?
  age         String?
  location    String?
  companySize String?
  priorities  String?
  goals       String?
  channels    String?
  budget      String?
  decisionProcess String?
  objections  String?
  pitchStrategy String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("personas")
}

// ============================================
// Proposal Models
// ============================================

model Proposal {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  title       String
  description String?
  clientName  String?
  clientEmail String?
  status      String   @default("draft") // draft, sent, approved, rejected, closed
  value       Float?
  currency    String   @default("USD")
  content     String?  // JSON or rich text content
  milestones  String?  // JSON array of milestones
  deliverables String? // JSON array of deliverables
  compensation String? // JSON compensation structure
  feedback    String?
  sentAt      DateTime?
  approvedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("proposals")
}

// ============================================
// Event Models
// ============================================

model Event {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  name        String
  description String?
  location    String?
  startDate   DateTime
  endDate     DateTime?
  eventType   String?  // Conference, Webinar, Meetup, etc.
  url         String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("events")
}

// ============================================
// Meeting Models
// ============================================

model Meeting {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  title       String
  description String?
  attendeeName String?
  attendeeEmail String?
  scheduledAt DateTime?
  duration    Int?     // Duration in minutes
  meetingType String?  // Call, Video, In-Person
  location    String?  // URL for video calls, address for in-person
  status      String   @default("scheduled") // scheduled, completed, cancelled, no-show
  notes       String?
  feedback    String?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("meetings")
}

// ============================================
// Ads Models
// ============================================

model AdCampaign {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  name        String
  platform    String   // Google, Facebook, LinkedIn, etc.
  status      String   @default("draft") // draft, active, paused, completed
  budget      Float?
  startDate   DateTime?
  endDate     DateTime?
  targetAudience String?
  adCopy      String?
  metrics     String?  // JSON object with metrics (clicks, impressions, conversions, etc.)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("ad_campaigns")
}